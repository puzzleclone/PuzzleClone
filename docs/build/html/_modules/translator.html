

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>translator &mdash; PuzzleClone v0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2fea6348"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            PuzzleClone
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">PuzzleClone</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PuzzleClone</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">translator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for translator</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">randint</span><span class="p">,</span> <span class="n">uniform</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">model.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuzzleTemplate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="c1"># Custom exception classes for better error handling</span>
<div class="viewcode-block" id="PuzzleGenerationError">
<a class="viewcode-back" href="../translator.html#translator.PuzzleGenerationError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PuzzleGenerationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for puzzle generation errors&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="NoSolutionError">
<a class="viewcode-back" href="../translator.html#translator.NoSolutionError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NoSolutionError</span><span class="p">(</span><span class="n">PuzzleGenerationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when Z3 solver cannot find any solution to the constraints&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="TooManySolutionsError">
<a class="viewcode-back" href="../translator.html#translator.TooManySolutionsError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TooManySolutionsError</span><span class="p">(</span><span class="n">PuzzleGenerationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the number of solutions exceeds the maximum allowed&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="AnswerAssertionError">
<a class="viewcode-back" href="../translator.html#translator.AnswerAssertionError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AnswerAssertionError</span><span class="p">(</span><span class="n">PuzzleGenerationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when answer assertion validation fails&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="RandomGenerationError">
<a class="viewcode-back" href="../translator.html#translator.RandomGenerationError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RandomGenerationError</span><span class="p">(</span><span class="n">PuzzleGenerationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when random number/option generation fails after multiple attempts&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ext">
<a class="viewcode-back" href="../translator.html#translator.ext">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ext</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    在s前后加空格以适应f&quot; &quot; &quot;环境</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\&quot;</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="k">else</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\&quot;</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="k">else</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<span class="n">symlist</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">use_spec_vars</span> <span class="o">=</span> <span class="p">[]</span>
<div class="viewcode-block" id="init_program">
<a class="viewcode-back" href="../translator.html#translator.init_program">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_program</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">symlist</span> 
    <span class="n">symlist</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;from random import randint, uniform</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">symlist</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# -*- coding: utf-8 -*-</span>
<span class="s2">from z3 import *</span>
<span class="s2">from random import randint, uniform, sample, choice</span>
<span class="s2">import itertools</span>
<span class="s2">from utils import *</span>
<span class="s2">from collections.abc import Iterable</span>
<span class="s2">from functools import reduce</span>
<span class="s2">import re</span>
<span class="s2">import os</span>
<span class="s2">import sys</span>
<span class="s2">set_option(timeout=15000)</span>
<span class="s2">INDEX_PATTERN = re.compile(r&#39;^__(</span><span class="se">\\</span><span class="s2">d+)__$&#39;)</span>

<span class="s2"># Custom exception classes for better error handling</span>
<span class="s2">class PuzzleGenerationError(Exception):</span>
<span class="s2">    pass</span>

<span class="s2">class NoSolutionError(PuzzleGenerationError):</span>
<span class="s2">    pass</span>

<span class="s2">class TooManySolutionsError(PuzzleGenerationError):</span>
<span class="s2">    pass</span>

<span class="s2">class AnswerAssertionError(PuzzleGenerationError):</span>
<span class="s2">    pass</span>

<span class="s2">class RandomGenerationError(PuzzleGenerationError):</span>
<span class="s2">    pass</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">p</span> <span class="o">+</span> <span class="s2">&quot;config = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="s2">&quot;config = __config__</span><span class="se">\n</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="resolve_rand">
<a class="viewcode-back" href="../translator.html#translator.resolve_rand">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve_rand</span><span class="p">(</span><span class="n">domain_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">isint</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">domain_data</span> <span class="o">=</span> <span class="n">domain_str</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isint</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;a = randint(int(</span><span class="si">{</span><span class="nb">eval</span><span class="p">(</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">symlist</span><span class="p">)</span><span class="si">}</span><span class="s2">), int(</span><span class="si">{</span><span class="nb">eval</span><span class="p">(</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">symlist</span><span class="p">)</span><span class="si">}</span><span class="s2">))&quot;</span><span class="p">,</span> <span class="n">symlist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">symlist</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;a = uniform(</span><span class="si">{</span><span class="nb">eval</span><span class="p">(</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">symlist</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">eval</span><span class="p">(</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">symlist</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">symlist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">symlist</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span></div>

     
<div class="viewcode-block" id="process_vars">
<a class="viewcode-back" href="../translator.html#translator.process_vars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_vars</span><span class="p">(</span><span class="n">Dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">codesol</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;generate_random_list&#39;</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;formula&quot;</span><span class="p">]:</span>
                <span class="n">codesol</span> <span class="o">+=</span> <span class="s2">&quot;set_local_context(locals())</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">codesol</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                <span class="n">domain_data</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">codesol</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = randint(int(</span><span class="si">{</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">), int(</span><span class="si">{</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">))</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span> <span class="ow">or</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
                <span class="n">domain_data</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">codesol</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = uniform(</span><span class="si">{</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span> <span class="ow">and</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">domain_data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">domain_data</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">domain_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">codesol</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">domain_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">codesol</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = choice([</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">domain_data</span><span class="p">])</span><span class="si">}</span><span class="s2">])</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Type </span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported&quot;</span><span class="p">)</span>
        <span class="n">codesol</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;config[</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">] = </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = config[</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">use_spec_vars</span> <span class="k">else</span> <span class="n">codesol</span>
    <span class="k">return</span> <span class="n">codegen</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>




<div class="viewcode-block" id="process_custom_operator">
<a class="viewcode-back" href="../translator.html#translator.process_custom_operator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_custom_operator</span><span class="p">(</span><span class="n">Dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="c1"># res = &quot;&quot;</span>
    <span class="c1"># for func in Dict:</span>
    <span class="c1">#     res += f&quot;def {func}:\n&quot;</span>
    <span class="c1">#     lines = Dict[func].split(&#39;\n&#39;)</span>
    <span class="c1">#     for line in lines:</span>
    <span class="c1">#         res += &#39;\t&#39; + line</span>
    <span class="c1"># return res + &#39;\n\n&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid_path</span><span class="p">(</span><span class="n">path_str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_valid_path</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">]):</span>
                <span class="n">_dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                <span class="n">_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;sys.path.append(</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">_dirname</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">)</span><span class="se">\n</span><span class="s2">from </span><span class="si">{</span><span class="n">_basename</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">continue</span>
            <span class="c1"># else:</span>
            <span class="c1">#     print(f&quot;Warning: Path &#39;{Dict[var]}&#39; does not exist and will be parsed as a function.&quot;)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="process_defined_symbols">
<a class="viewcode-back" href="../translator.html#translator.process_defined_symbols">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_defined_symbols</span><span class="p">(</span><span class="n">sym</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;source&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">res</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
    <span class="n">type_text</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">types</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">types</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
    <span class="n">descs</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span>
    <span class="n">desc_text</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">descs</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">descs</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
    <span class="n">source_text</span> <span class="o">=</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attr&#39;</span><span class="p">)</span>  <span class="c1"># Use .get() to avoid KeyError</span>
    <span class="n">attr_text</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
    <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = CustomSym(</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">, </span><span class="si">{</span><span class="n">source_text</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">attr_text</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">type_text</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">desc_text</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="process_multiple_derived_symbols">
<a class="viewcode-back" href="../translator.html#translator.process_multiple_derived_symbols">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_multiple_derived_symbols</span><span class="p">(</span><span class="n">sym</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">templates</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">templates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_total = </span><span class="si">{</span><span class="n">templates</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_num_of_templates = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">])</span><span class="si">}</span>
<span class="s2">_pool_domain = generate_random_list_with_total(_num_of_templates,  [0, _total], _total, </span><span class="si">{</span><span class="p">[</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;domain&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;domain&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">templates</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]]</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="se">{{</span><span class="s2">&quot;pool_domain&quot;: _pool_domain, &quot;pool&quot;: []</span><span class="se">}}</span>
<span class="s2">_index = 0</span>
<span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = []</span>
<span class="s2">_desc = []</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_domain = config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;][&quot;pool_domain&quot;]</span>
<span class="s2">_index = 0</span>
<span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = []</span>
<span class="s2">_desc = []</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]):</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># Generate Symbols for Template #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span>
<span class="s2">_domain = _pool_domain[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_domain_cond = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;domain_cond&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_dim = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_dim_cond = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;dim_cond&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_custom_cond = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;custom_cond&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_pool_len = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;len(&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_pool_amount = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;1 for _ in range(len(_pool_len))&quot;</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">try:</span>
<span class="s2">    _pool_indices, _pool_indices_str = generate_random_indices(_pool_len, _pool_amount, _domain, domain_cond=_domain_cond, dim=_dim, dim_cond=_dim_cond, custom_cond=_custom_cond, order=</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, duplicate=</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;duplicate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, env=globals())</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    raise RandomGenerationError(f&quot;Failed to generate random indices for multiple derived symbols template #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. This typically happens when the constraints are too restrictive or conflicting, making it impossible to generate valid random samples. Please retry, use &#39;-c&#39; for continuous mode, or review and revise the domain conditions, dimensions, and custom conditions for this template.&quot;)</span>
<span class="s2">config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;][&quot;pool&quot;].append(_pool_indices_str)</span>
<span class="s2">_pool_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_vals = [[[list(src)[idx] for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, item) ] for item in _pool_indices ]</span>
<span class="s2">for _ind, _sym in zip(_pool_indices, _pool_vals):</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_ind = [item[0] for item in _ind]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">    set_local_context(locals())</span>
<span class="s2">    _s = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">    _d = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.append(_s)</span>
<span class="s2">    _desc.append(_d)</span>
<span class="s2">    _index += 1</span>
<span class="s2">    store_sym_config(_s, </span><span class="se">{{</span><span class="s2">&quot;desc&quot;: _d, &quot;data&quot;: _sym</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># Generate Symbols for Template #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span>
<span class="s2">_domain = _pool_domain[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_pool_indices = config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;][&quot;pool&quot;][</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_pool_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_pool_vals = [[[list(src)[int(m.group(1))] if (m := INDEX_PATTERN.match(str(idx))) else idx for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, item) ] for item in _pool_indices ]</span>
<span class="s2">for _ind, _sym in zip(_pool_indices, _pool_vals):</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_ind = [item[0] for item in _ind]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">    set_local_context(locals())</span>
<span class="s2">    _s = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">    _d = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.append(_s)</span>
<span class="s2">    _desc.append(_d)</span>
<span class="s2">    _index += 1</span>
<span class="s2">    store_sym_config(_s, </span><span class="se">{{</span><span class="s2">&quot;desc&quot;: _d, &quot;data&quot;: _sym</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_vals = [[[[list(src)[idx] for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, _idx_dim) ] for _idx_dim in _idx_domain] for _idx_domain in _pool_indices ]</span>
<span class="s2">for _pool_vals_domain in _pool_vals:</span>
<span class="s2">    _ss = []</span>
<span class="s2">    _dd = []</span>
<span class="s2">    for _sym in _pool_vals_domain:</span>
<span class="s2">        </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">        set_local_context(locals())</span>
<span class="s2">        _s = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        _d = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">        _ss.append(_s)</span>
<span class="s2">        _dd.append(_d)</span>
<span class="s2">        store_sym_config(_s, </span><span class="se">{{</span><span class="s2">&quot;desc&quot;: _d, &quot;data&quot;: _sym</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.append(_ss)</span>
<span class="s2">    _desc.append(_dd)</span>
<span class="s2">    _index += 1</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># Generate Symbols for Template #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span>
<span class="s2">_domain = _pool_domain[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_pool_indices = config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;][&quot;pool&quot;][&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;]</span>
<span class="s2">_pool_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_pool_vals = [[[[list(src)[int(m.group(1))] if (m := INDEX_PATTERN.match(str(idx))) else idx for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, _idx_dim) ] for _idx_dim in _idx_domain ] for _idx_domain in _pool_indices ]</span>
<span class="s2">for  _index, _pool_vals_domain in enumerate(_pool_vals):</span>
<span class="s2">    _ss = []</span>
<span class="s2">    _dd = []</span>
<span class="s2">    for _sym in _pool_vals_domain:</span>
<span class="s2">        </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">        set_local_context(locals())</span>
<span class="s2">        _s = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        _d = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">        _ss.append(_s)</span>
<span class="s2">        _dd.append(_d)</span>
<span class="s2">        store_sym_config(_s, </span><span class="se">{{</span><span class="s2">&quot;desc&quot;: _d, &quot;data&quot;: _sym</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.append(_ss)</span>
<span class="s2">    _desc.append(_dd)</span>
<span class="s2">    _index += 1</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">store_sym_config(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">, </span><span class="se">{{</span><span class="s2">&quot;desc&quot;: _desc, &quot;data&quot;: _pool_vals</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">store_sym_config(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">, </span><span class="se">{{</span><span class="s2">&quot;desc&quot;: _desc, &quot;data&quot;: _pool_vals</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span></div>


<div class="viewcode-block" id="process_single_derived_symbols">
<a class="viewcode-back" href="../translator.html#translator.process_single_derived_symbols">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_single_derived_symbols</span><span class="p">(</span><span class="n">sym</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span>

    <span class="c1"># 随机化参数</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_domain = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_domain_cond = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;domain_cond&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_dim = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_dim_cond = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;dim_cond&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_custom_cond = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;custom_cond&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_pool_len = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;len(&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_pool_amount = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_pool_amount = [1 for _ in range(len(_pool_len))]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">try:</span>
<span class="s2">    _pool_indices, _pool_indices_str = generate_random_indices(_pool_len, _pool_amount, _domain, domain_cond=_domain_cond, dim=_dim, dim_cond=_dim_cond, custom_cond=_custom_cond, order=</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, duplicate=</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;duplicate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, env=globals())</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    raise RandomGenerationError(f&quot;Failed to generate random indices for single derived symbol &#39;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. This typically happens when the constraints are too restrictive or conflicting, making it impossible to generate valid random samples. Please retry, use &#39;-c&#39; for continuous mode, or review and revise the domain conditions, dimensions, and custom conditions.&quot;)</span>
<span class="s2">config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="se">{{</span><span class="s2">&quot;pool&quot;: _pool_indices_str</span><span class="se">}}</span>
<span class="s2">_pool_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = []</span>
<span class="s2">_desc = []</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_vals = [[[list(src)[idx] for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, item) ] for item in _pool_indices ]</span>
<span class="s2">for _index, _sym in enumerate(_pool_vals):</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">    set_local_context(locals())</span>
<span class="s2">    _s = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">    _d = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.append(_s)</span>
<span class="s2">    _desc.append(_d)</span>
<span class="s2">store_sym_config(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">, </span><span class="se">{{\&quot;</span><span class="s2">desc</span><span class="se">\&quot;</span><span class="s2">: _desc, </span><span class="se">\&quot;</span><span class="s2">data</span><span class="se">\&quot;</span><span class="s2">: _pool_vals</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">for _index, _sym in enumerate(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">):</span>
<span class="s2">    store_sym_config(_sym, </span><span class="se">{{\&quot;</span><span class="s2">desc</span><span class="se">\&quot;</span><span class="s2">: _desc[_index], </span><span class="se">\&quot;</span><span class="s2">data</span><span class="se">\&quot;</span><span class="s2">: _pool_vals[_index]</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_domain = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_pool_indices = config[</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">][</span><span class="se">\&quot;</span><span class="s2">pool</span><span class="se">\&quot;</span><span class="s2">]</span>
<span class="s2">_pool_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_pool_vals = [[[list(src)[int(m.group(1))] if (m := INDEX_PATTERN.match(str(idx))) else idx for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, item) ] for item in _pool_indices ]</span>
<span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = []</span>
<span class="s2">_desc = []</span>
<span class="s2">for _index, _sym in enumerate(_pool_vals):</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">    set_local_context(locals())</span>
<span class="s2">    _s = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">    _d = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.append(_s)</span>
<span class="s2">    _desc.append(_d)</span>
<span class="s2">store_sym_config(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">, </span><span class="se">{{\&quot;</span><span class="s2">desc</span><span class="se">\&quot;</span><span class="s2">: _desc, </span><span class="se">\&quot;</span><span class="s2">data</span><span class="se">\&quot;</span><span class="s2">: _pool_vals</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">for _index, _sym in enumerate(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">):</span>
<span class="s2">    store_sym_config(_sym, </span><span class="se">{{\&quot;</span><span class="s2">desc</span><span class="se">\&quot;</span><span class="s2">: _desc[_index], </span><span class="se">\&quot;</span><span class="s2">data</span><span class="se">\&quot;</span><span class="s2">: _pool_vals[_index]</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_vals = [[[[list(src)[idx] for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, _idx_dim) ] for _idx_dim in _idx_domain] for _idx_domain in _pool_indices ]</span>
<span class="s2">for  _index, _pool_vals_domain in enumerate(_pool_vals):</span>
<span class="s2">    _ss = []</span>
<span class="s2">    _dd = []</span>
<span class="s2">    for _sym in _pool_vals_domain:</span>
<span class="s2">        </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">        set_local_context(locals())</span>
<span class="s2">        _s = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        _d = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">        _ss.append(_s)</span>
<span class="s2">        _dd.append(_d)</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.append(_ss)</span>
<span class="s2">    _desc.append(_dd)</span>
<span class="s2">store_sym_config(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">, </span><span class="se">{{\&quot;</span><span class="s2">desc</span><span class="se">\&quot;</span><span class="s2">: _desc, </span><span class="se">\&quot;</span><span class="s2">data</span><span class="se">\&quot;</span><span class="s2">: _pool_vals</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">for _idx_domain, _sym_d in enumerate(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">):</span>
<span class="s2">    for _idx_dim, _sym in enumerate(_sym_d):</span>
<span class="s2">        store_sym_config(_sym, </span><span class="se">{{\&quot;</span><span class="s2">desc</span><span class="se">\&quot;</span><span class="s2">: _desc[_idx_domain][_idx_dim], </span><span class="se">\&quot;</span><span class="s2">data</span><span class="se">\&quot;</span><span class="s2">: _pool_vals[_idx_domain][_idx_dim]</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_domain = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_pool_indices = config[</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">][</span><span class="se">\&quot;</span><span class="s2">pool</span><span class="se">\&quot;</span><span class="s2">]</span>
<span class="s2">_pool_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = []</span>
<span class="s2">_desc = []</span>
<span class="s2">_pool_vals = [[[[list(src)[int(m.group(1))] if (m := INDEX_PATTERN.match(str(idx))) else idx for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, _idx_dim) ] for _idx_dim in _idx_domain ] for _idx_domain in _pool_indices ]</span>
<span class="s2">for  _index, _pool_vals_domain in enumerate(_pool_vals):</span>
<span class="s2">    _ss = []</span>
<span class="s2">    _dd = []</span>
<span class="s2">    for _sym in _pool_vals_domain:</span>
<span class="s2">        </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">        set_local_context(locals())</span>
<span class="s2">        _s = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        _d = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">        _ss.append(_s)</span>
<span class="s2">        _dd.append(_d)</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.append(_ss)</span>
<span class="s2">    _desc.append(_dd)</span>
<span class="s2">store_sym_config(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">, </span><span class="se">{{\&quot;</span><span class="s2">desc</span><span class="se">\&quot;</span><span class="s2">: _desc, </span><span class="se">\&quot;</span><span class="s2">data</span><span class="se">\&quot;</span><span class="s2">: _pool_vals</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">for _idx_domain, _sym_d in enumerate(</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">):</span>
<span class="s2">    for _idx_dim, _sym in enumerate(_sym_d):</span>
<span class="s2">        store_sym_config(_sym, </span><span class="se">{{\&quot;</span><span class="s2">desc</span><span class="se">\&quot;</span><span class="s2">: _desc[_idx_domain][_idx_dim], </span><span class="se">\&quot;</span><span class="s2">data</span><span class="se">\&quot;</span><span class="s2">: _pool_vals[_idx_domain][_idx_dim]</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

    
    <span class="k">return</span> <span class="n">codegen</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="process_symbols">
<a class="viewcode-back" href="../translator.html#translator.process_symbols">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_symbols</span><span class="p">(</span><span class="n">Dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">]:</span> <span class="c1"># DefinedSymbol</span>
            <span class="n">codesol</span> <span class="o">=</span> <span class="n">process_defined_symbols</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;total&quot;</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;templates&quot;</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">]:</span> <span class="c1"># DerivedSymbols</span>
            <span class="n">codesol</span> <span class="o">=</span> <span class="n">process_multiple_derived_symbols</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># DerivedSymbol</span>
            <span class="n">codesol</span> <span class="o">=</span> <span class="n">process_single_derived_symbols</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">codegen</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>



<div class="viewcode-block" id="process_static_conditions">
<a class="viewcode-back" href="../translator.html#translator.process_static_conditions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_static_conditions</span><span class="p">(</span><span class="n">sym</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">]:</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = &#39;&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;conditions += </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_conditions.append(</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="process_dynamic_conditions">
<a class="viewcode-back" href="../translator.html#translator.process_dynamic_conditions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_dynamic_conditions</span><span class="p">(</span><span class="n">sym</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">codesol</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = CustomCond(desc = f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">)</span>
<span class="s2">_conditions.append(</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">conditions += (</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.desc if </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.desc else &#39;&#39;)</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span>
        <span class="k">return</span> <span class="n">codegen</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>

    <span class="c1"># 生成随机domain</span>
    <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_num = randint(</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_num = 1</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;config[</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">] = </span><span class="se">{{\&quot;</span><span class="s2">domain</span><span class="se">\&quot;</span><span class="s2">: _num</span><span class="se">}}\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_num = config[</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">][</span><span class="se">\&quot;</span><span class="s2">domain</span><span class="se">\&quot;</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="c1"># 生成随机下标</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_pool_len = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;len(&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_pool_amount = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_pool_amount = [1 for _ in range(len(_pool_len))]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">try:</span>
<span class="s2">    _pool_indices, _pool_indices_str = generate_random_indices(_pool_len, _pool_amount, _num, domain_cond=</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;domain_cond&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, custom_cond=</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;custom_cond&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, env=globals())</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    raise RandomGenerationError(f&quot;Failed to generate random indices for dynamic condition &#39;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. This typically happens when the constraints are too restrictive or conflicting, making it impossible to generate valid random samples. Please retry, use &#39;-c&#39; for continuous mode, or review and revise the domain conditions and custom conditions.&quot;)</span>
<span class="s2">config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;][&quot;pool&quot;] = _pool_indices_str</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_pool_indices = config[</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">][</span><span class="se">\&quot;</span><span class="s2">pool</span><span class="se">\&quot;</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_pool_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_pool_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="s2">&quot;_pool_vals = [[[list(src)[idx] for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, item) ] for item in _pool_indices ]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="s2">&quot;_pool_vals = [[[list(src)[int(m.group(1))] if (m := INDEX_PATTERN.match(str(idx))) else idx for idx in idx_tuple] for src, idx_tuple in zip(_pool_sources, item) ] for item in _pool_indices ]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = CustomCond(domain=_num, data=_pool_vals)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = CustomCond(domain=_num, data=_pool_vals)</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;for _index, _sym in enumerate(_pool_vals):</span><span class="se">\n</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_ind = [item[0] for item in _pool_indices[_index]]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;_ind = _pool_indices[_index]&#39;</span><span class="si">}</span>
<span class="s2">    _conditions.append(</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.desc += f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;</span>
<span class="s2">conditions += (</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.desc if </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.desc else &#39;&#39;)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;for _index, _sym in enumerate(_pool_vals):</span><span class="se">\n</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_sym = [item[0] for item in _sym]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_ind = [item[0] for item in _pool_indices[_index]]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;_ind = _pool_indices[_index]&#39;</span><span class="si">}</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;_ind = [int(m.group(1)) if (m := INDEX_PATTERN.match(str(idx))) else idx for idx in _ind]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;_ind = [[int(m.group(1)) if (m := INDEX_PATTERN.match(str(idx))) else idx  for idx in item] for item in _ind]&#39;</span><span class="si">}</span>
<span class="s2">    _conditions.append(</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">    </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.desc += f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;</span>
<span class="s2">conditions += (</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.desc if </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">.desc else &#39;&#39;)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">codegen</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="process_conditions">
<a class="viewcode-back" href="../translator.html#translator.process_conditions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_conditions</span><span class="p">(</span><span class="n">Dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codesol</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_conditions = []</span>
<span class="s2">conditions = &quot;&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">]:</span> <span class="c1"># DynamicCondition</span>
            <span class="n">codesol</span> <span class="o">=</span> <span class="n">process_dynamic_conditions</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># StaticCondition</span>
            <span class="n">codesol</span> <span class="o">=</span> <span class="n">process_static_conditions</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">codegen</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="process_post_generation">
<a class="viewcode-back" href="../translator.html#translator.process_post_generation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_post_generation</span><span class="p">(</span><span class="n">Dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">calc_solution</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># 随机选取一个解，作为生成问题的基准</span>
    <span class="n">codesol</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;_solver = Solver()</span>
<span class="s2">for cond in _conditions:</span>
<span class="s2">    _solver.add(cond)</span>
<span class="s2">_solver_size = len(_solver.assertions())</span>
<span class="s2">_solutions = []</span>
<span class="s2">_solver.set(&#39;random_seed&#39;, 50)</span>
<span class="s2">cnt = 0 </span>
<span class="s2">while _solver.check() == sat and cnt &lt; 10: # 只取前10组解</span>
<span class="s2">    model = _solver.model()  # 获取当前解</span>
<span class="s2">    _solutions.append(model)  # 保存解</span>
<span class="s2">    cnt += 1</span>
<span class="s2">    </span>
<span class="s2">    # 添加排除条件：排除当前解的所有变量赋值</span>
<span class="s2">    block = []</span>
<span class="s2">    for var in model:</span>
<span class="s2">        block.append(var() != model[var])  # 对每个变量添加反向约束</span>
<span class="s2">    _solver.add(Or(block))  # 要求至少有一个变量与当前解不同</span>
<span class="s2">sort_solutions(_solutions)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;_sol_id = 0</span>
<span class="s2">config[&quot;_sol_id&quot;] = _sol_id</span>
<span class="s2">_sol = _solutions[_sol_id] </span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;_sol_id = config[&quot;_sol_id&quot;]</span>
<span class="s2">_sol = _solutions[_sol_id]</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="c1"># 对于post_gen_vars中的每个符号，代入目标解中的值</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="s2">&quot;_post_gen_conditions = []</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="s2">&quot;_post_gen_conditions = []</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="s2">&quot;post_gen_conditions = </span><span class="se">\&quot;\&quot;\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="s2">&quot;post_gen_conditions = </span><span class="se">\&quot;\&quot;\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;post_gen_vars&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;post_gen_vars&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span>
<span class="s2">config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;]</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="k">if</span> <span class="n">sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">use_spec_vars</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span>
<span class="s2">config[&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="c1"># 对于post_gen_condition中的每个条件，代入新问题</span>
    <span class="k">if</span> <span class="n">calc_solution</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;post_gen_conditions&quot;</span><span class="p">]:</span>
            <span class="n">codesol2</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;post_gen_conditions&quot;</span><span class="p">]:</span>
                <span class="n">codesol2</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2"> = f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;post_gen_conditions&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;</span>
<span class="s2">_post_gen_conditions.append(</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;post_gen_conditions&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">if </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2"> != &#39;&#39;:</span>
<span class="s2">    post_gen_conditions += </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2"> + &#39;;&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol2</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol2</span>
                
        <span class="n">codesol3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_solver.reset()</span>
<span class="s2">for cond in _conditions:</span>
<span class="s2">    _solver.add(cond)</span>
<span class="s2">for cond in _post_gen_conditions:</span>
<span class="s2">    _solver.add(cond)</span>
<span class="s2">_solver_size = len(_solver.assertions())</span>
<span class="s2">_solutions = []</span>
<span class="s2">while _solver.check() == sat:</span>
<span class="s2">    model = _solver.model()  # 获取当前解</span>
<span class="s2">    _solutions.append(model)  # 保存解</span>
<span class="s2">    </span>
<span class="s2">    # 添加排除条件：排除当前解的所有变量赋值</span>
<span class="s2">    block = []</span>
<span class="s2">    for var in model:</span>
<span class="s2">        block.append(var() != model[var])  # 对每个变量添加反向约束</span>
<span class="s2">    _solver.add(Or(block))  # 要求至少有一个变量与当前解不同</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol3</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">codesol3</span> <span class="o">=</span> <span class="s2">&quot;_solver_size = 0</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol3</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol3</span>
    <span class="k">return</span> <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span></div>


<div class="viewcode-block" id="process_optimize">
<a class="viewcode-back" href="../translator.html#translator.process_optimize">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_optimize</span><span class="p">(</span><span class="n">Dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">optimize_type</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
    <span class="n">optimize_formula</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span>
    <span class="n">codesol</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;_solver = Optimize()</span>
<span class="s2">for cond in _conditions:</span>
<span class="s2">    _solver.add(cond)</span>
<span class="s2">_optimize_type = f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">optimize_type</span><span class="si">}</span><span class="se">\&quot;</span>
<span class="s2">_optimize_formula = </span><span class="si">{</span><span class="n">optimize_formula</span><span class="si">}</span>
<span class="s2">if _optimize_type == &#39;minimize&#39;:</span>
<span class="s2">    _solver.minimize(_optimize_formula)</span>
<span class="s2">else:</span>
<span class="s2">    _solver.maximize(_optimize_formula)</span>
<span class="s2">_solver_size = len(_solver.assertions())</span>
<span class="s2">_solutions = []</span>
<span class="s2">_value = None</span>
<span class="s2"># print(_solver)</span>
<span class="s2">try:</span>
<span class="s2">    if _solver.check() == sat:</span>
<span class="s2">        model = _solver.model()  # 获取当前解</span>
<span class="s2">        _solutions.append(model)  # 保存解</span>
<span class="s2">        _value = model.evaluate(_optimize_formula)</span>
<span class="s2">        # 添加排除条件：排除当前解的所有变量赋值</span>
<span class="s2">        block = []</span>
<span class="s2">        for var in model:</span>
<span class="s2">            block.append(var() != model[var])  # 对每个变量添加反向约束</span>
<span class="s2">        _solver.add(Or(block))  # 要求至少有一个变量与当前解不同</span>
<span class="s2">        _solver.add((_optimize_formula) == _value)</span>
<span class="s2">        if _solver.check() == sat:</span>
<span class="s2">            raise RandomGenerationError(f&quot;The optimization problem has multiple optimal solutions with value </span><span class="se">{{</span><span class="s2">_value</span><span class="se">}}</span><span class="s2">. This makes the puzzle ambiguous. Please retry, use &#39;-c&#39; for continuous mode, or add additional constraints to ensure a unique optimal solution.&quot;)</span>
<span class="s2">    else:</span>
<span class="s2">        raise NoSolutionError(f&quot;Z3 optimizer could not find any solution that satisfies the constraints for </span><span class="se">{{</span><span class="s2">_optimize_type</span><span class="se">}}</span><span class="s2"> optimization of </span><span class="se">{{</span><span class="s2">_optimize_formula</span><span class="se">}}</span><span class="s2">. Please retry, use &#39;-c&#39; for continuous mode, or review your constraints and optimization objective.&quot;)</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    if isinstance(e, (NoSolutionError, RandomGenerationError)):</span>
<span class="s2">        raise e</span>
<span class="s2">    else:</span>
<span class="s2">        raise RandomGenerationError(f&quot;Z3 optimizer encountered an error: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. This might be due to timeout, resource constraints, or complex optimization objectives. Please retry, use &#39;-c&#39; for continuous mode, or try again or simplify the problem.&quot;)</span>

<span class="s2">assert(len(_solutions) == 1)</span>
<span class="s2">_solutions = _solutions[0]</span>
<span class="s2"># print(_solutions, _value)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="s2">&quot;print(</span><span class="se">\&quot;</span><span class="s2">Number of solutions:</span><span class="se">\&quot;</span><span class="s2">, len(_solutions)) </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span></div>

<div class="viewcode-block" id="process_query">
<a class="viewcode-back" href="../translator.html#translator.process_query">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_query</span><span class="p">(</span><span class="n">Dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codesol</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;queries = &#39;&#39;</span>
<span class="s2">ans = []</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="s2">&quot;config[&#39;_queries&#39;] = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        
        
        <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;templates&quot;</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">]:</span> <span class="c1"># 选择题</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2"> = CustomCond(desc=f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> + &#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2"> = CustomCond(desc=f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> + &#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;templates&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">]:</span>
                <span class="n">tmpcode</span> <span class="o">=</span> <span class="n">process_single_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">cnt</span><span class="p">)</span>
                <span class="n">codegen</span> <span class="o">+=</span> <span class="n">tmpcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">codeval</span> <span class="o">+=</span> <span class="n">tmpcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpcode</span> <span class="o">=</span> <span class="n">process_multiple_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">cnt</span><span class="p">)</span>
                <span class="n">codegen</span> <span class="o">+=</span> <span class="n">tmpcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">codeval</span> <span class="o">+=</span> <span class="n">tmpcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
        <span class="k">else</span><span class="p">:</span> <span class="c1"># 问答题</span>
            <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_ans = </span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">try:</span>
<span class="s2">    assert(</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_assertion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">except AssertionError as e:</span>
<span class="s2">    raise AnswerAssertionError(f&quot;Answer assertion failed for query &#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">{{</span><span class="s2">str(e) if str(e) else &#39;Assertion condition not met&#39;</span><span class="se">}}</span><span class="s2">. The generated answer &#39;</span><span class="se">{{</span><span class="s2">_ans</span><span class="se">}}</span><span class="s2">&#39; does not satisfy the assertion &#39;</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_assertion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. This indicates that the constraints or answer formula may be inconsistent. Please retry, use &#39;-c&#39; for continuous mode, or review and revise the query specification.&quot;)</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    raise AnswerAssertionError(f&quot;Answer assertion evaluation failed for query &#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. There may be an error in the assertion formula &#39;</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_assertion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; or the answer formula &#39;</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Please retry, use &#39;-c&#39; for continuous mode, or check the syntax and logic in your specification.&quot;)</span>
<span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2"> = CustomCond(desc=f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> + &#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span>
<span class="s2">queries += </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">. </span><span class="se">\&quot;</span><span class="s2"> + </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc</span>
<span class="s2">ans.append(str(</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">))</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_ans = </span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_formula&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">try:</span>
<span class="s2">    assert(</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_assertion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">except AssertionError as e:</span>
<span class="s2">    raise AnswerAssertionError(f&quot;Answer assertion failed for query &#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">{{</span><span class="s2">str(e) if str(e) else &#39;Assertion condition not met&#39;</span><span class="se">}}</span><span class="s2">. The generated answer &#39;</span><span class="se">{{</span><span class="s2">_ans</span><span class="se">}}</span><span class="s2">&#39; does not satisfy the assertion &#39;</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_assertion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. This indicates that the constraints or answer formula may be inconsistent. Please retry, use &#39;-c&#39; for continuous mode, or review and revise the query specification.&quot;)</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    raise AnswerAssertionError(f&quot;Answer assertion evaluation failed for query &#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. There may be an error in the assertion formula &#39;</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_assertion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; or the answer formula &#39;</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Please retry, use &#39;-c&#39; for continuous mode, or check the syntax and logic in your specification.&quot;)</span>
<span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2"> = CustomCond(desc=f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> + &#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span>
<span class="s2">queries += </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">. </span><span class="se">\&quot;</span><span class="s2"> + </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc</span>
<span class="s2">ans.append(str(</span><span class="si">{</span><span class="n">Dict</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;ans_text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">))</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="s2">&quot;ans = &#39;====&#39;.join([str(v) for v in ans])</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="s2">&quot;ans = &#39;====&#39;.join([str(v) for v in ans])</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">codegen</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span></div>



<div class="viewcode-block" id="process_single_query">
<a class="viewcode-back" href="../translator.html#translator.process_single_query">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_single_query</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qconfig</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cnt</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># 生成随机数池</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_source = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_amount = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]))])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_correct_num = </span><span class="si">{</span><span class="mi">1</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;opt_num&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
<span class="s2">_incorrect_num = </span><span class="si">{</span><span class="mi">1</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;opt_num&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
<span class="s2">try:</span>
<span class="s2">    _satisfied_configs, _unsatisfied_configs, _satisfied, _unsatisfied = find_required_event_groups(_source, _correct_num, _incorrect_num, _solutions, &quot;</span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;opt_formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;, cond = &quot;</span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;cond&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;, event_num = _amount, order = </span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, duplicate = </span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;duplicate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, custom_cond = </span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;custom_cond&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, env = globals())</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    raise RandomGenerationError(f&quot;Failed to generate options for query &#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. This typically happens when it&#39;s impossible to find enough valid/invalid options that satisfy the constraints. Please retry, use &#39;-c&#39; for continuous mode, or review and revise the query conditions, source data, or reduce the number of required options.&quot;)</span>
<span class="s2">&quot;&quot;&quot;</span>         

    <span class="c1"># 生成选项</span>
    <span class="k">if</span> <span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># 问的是正确选项：1个正确项 + （opt_num - 1)个错误项</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">opt_num = </span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;opt_num&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_ans_index = randint(0, opt_num - 1)</span>
<span class="s2">_opts = _unsatisfied[:_ans_index] + _satisfied + _unsatisfied[_ans_index:]</span>
<span class="s2">_configs = _unsatisfied_configs[:_ans_index] + _satisfied_configs + _unsatisfied_configs[_ans_index:]</span>
<span class="s2">config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="se">{{</span><span class="s2">&quot;pool&quot;: _configs</span><span class="se">}}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># 问的是错误选项：1个错误项 + （opt_num - 1)个正确项</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">opt_num = </span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;opt_num&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_ans_index = randint(0, opt_num - 1)</span>
<span class="s2">_opts = _satisfied[:_ans_index] + _unsatisfied + _satisfied[_ans_index:]</span>
<span class="s2">_configs = _satisfied_configs[:_ans_index] + _unsatisfied_configs + _satisfied_configs[_ans_index:]</span>
<span class="s2">config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="se">{{</span><span class="s2">&quot;pool&quot;: _configs</span><span class="se">}}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_source = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_config_opts = config[&quot;_queries&quot;][</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">][&quot;pool&quot;]</span>
<span class="s2">_opts = []</span>
<span class="s2">for _opt in _config_opts:</span>
<span class="s2">    _opts.append([[list(src)[int(m.group(1))] if (m := INDEX_PATTERN.match(str(idx))) else list(src)[idx] for idx in idx_tuple] for src, idx_tuple in zip (_source, _opt)])</span>

<span class="s2">_ans_index = &quot;&quot;</span>
<span class="s2">for _ind, _opt in enumerate(_opts):</span>
<span class="s2">    if is_option_valid(_opt, </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;opt_formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;cond&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">, </span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, globals()):</span>
<span class="s2">        _ans_index += chr(_ind + 65)</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="c1"># 生成选项文本</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_opt_text = []</span>
<span class="s2">for _index, _opt in enumerate(_opts):</span>
<span class="s2">    _opt_text.append(chr(_index + 65) + &#39;. &#39; + f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;opt_text&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">)</span>
<span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc += &#39;</span><span class="se">\\</span><span class="s2">n&#39;.join(_opt_text) + &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_opt_text = []</span>
<span class="s2">for _index, _opt in enumerate(_opts):</span>
<span class="s2">    _opt_text.append(chr(_index + 65) + &#39;. &#39; + f</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;opt_text&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">)</span>
<span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc += &#39;</span><span class="se">\\</span><span class="s2">n&#39;.join(_opt_text) + &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>


    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;queries += </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">. </span><span class="se">\&quot;</span><span class="s2"> + </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc + &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;queries += </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">. </span><span class="se">\&quot;</span><span class="s2"> + </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc + &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># 生成答案</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ans.append(chr(_ans_index + 65))</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ans.append(_ans_index)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span></div>

<div class="viewcode-block" id="process_multiple_query">
<a class="viewcode-back" href="../translator.html#translator.process_multiple_query">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_multiple_query</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qconfig</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cnt</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">codegen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codeval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">opt_num = </span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;opt_num&quot;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">_num_of_templates = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">])</span><span class="si">}</span>
<span class="s2">_pool_domain = generate_random_list_with_total(_num_of_templates, [0, opt_num], opt_num, </span><span class="si">{</span><span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;domain&quot;</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;domain&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]]</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="se">{{</span><span class="s2">&quot;pool_domain&quot;: _pool_domain, &quot;pool&quot;: []</span><span class="se">}}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;select_type&quot;</span><span class="p">]:</span> <span class="c1"># 问的是正确选项：1个正确项 + （opt_num - 1)个错误项</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_incorrect_num = generate_random_list_with_total(_num_of_templates,  [0, opt_num - 1], opt_num - 1, [[0, v] for v in _pool_domain])</span>
<span class="s2">_pool_correct_num = [x - y for x, y in zip(_pool_domain, _pool_incorrect_num)]</span>
<span class="s2">config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="se">{{</span><span class="s2">&quot;pool_domain&quot;: _pool_domain, &quot;pool_correct_num&quot;: _pool_correct_num, &quot;pool_incorrect_num&quot;: _pool_incorrect_num, &quot;pool&quot;: []</span><span class="se">}}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_correct_num = generate_random_list_with_total(_num_of_templates, [0, opt_num - 1], opt_num - 1, [[0, v] for v in _pool_domain])</span>
<span class="s2">_pool_incorrect_num = [x - y for x, y in zip(_pool_domain, _pool_correct_num)]</span>
<span class="s2">config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;] = </span><span class="se">{{</span><span class="s2">&quot;pool_domain&quot;: _pool_domain, &quot;pool_correct_num&quot;: _pool_correct_num, &quot;pool_incorrect_num&quot;: _pool_incorrect_num, &quot;pool&quot;: []</span><span class="se">}}</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_domain = config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;][&quot;pool_domain&quot;]</span>
<span class="s2">_pool_correct_num = config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;][&quot;pool_correct_num&quot;]</span>
<span class="s2">_pool_incorrect_num = config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;][&quot;pool_incorrect_num&quot;]</span>
<span class="s2">&quot;&quot;&quot;</span>
    
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_pool_satisfied_configs = []</span>
<span class="s2">_pool_unsatisfied_configs = []</span>
<span class="s2">_pool_satisfied = []</span>
<span class="s2">_pool_unsatisfied = []</span>
<span class="s2">&quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]):</span>
        <span class="k">assert</span><span class="p">(</span><span class="s1">&#39;dim&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">template</span> <span class="ow">or</span> <span class="n">template</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 生成随机数池</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># Generate Options for Template #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span>
<span class="s2">_domain = _pool_domain[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_source = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_amount = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]))])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_correct_num = _pool_correct_num[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">_incorrect_num = _pool_incorrect_num[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">try:</span>
<span class="s2">    _satisfied_configs, _unsatisfied_configs, _satisfied, _unsatisfied = find_required_event_groups(_source, _correct_num, _incorrect_num, _solutions, &quot;</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;opt_formula&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;, cond = &quot;</span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;cond&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;, event_num = _amount, order = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, duplicate = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;duplicate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, custom_cond = </span><span class="si">{</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;custom_cond&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, env = globals())</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    raise RandomGenerationError(f&quot;Failed to generate options for multiple query &#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#39; template #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. This typically happens when it&#39;s impossible to find enough valid/invalid options that satisfy the constraints for this template. Please retry, use &#39;-c&#39; for continuous mode, or review and revise the query conditions, source data, or reduce the number of required options.&quot;)</span>
<span class="s2">_pool_satisfied_configs.extend(map(lambda item: </span><span class="se">{{</span><span class="s2">&quot;template_id&quot;: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, &quot;config&quot;: item</span><span class="se">}}</span><span class="s2">, _satisfied_configs))</span>
<span class="s2">_pool_unsatisfied_configs.extend(map(lambda item: </span><span class="se">{{</span><span class="s2">&quot;template_id&quot;: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, &quot;config&quot;: item</span><span class="se">}}</span><span class="s2">, _unsatisfied_configs))</span>
<span class="s2">_pool_satisfied.extend(_satisfied)</span>
<span class="s2">_pool_unsatisfied.extend(_unsatisfied)</span>
<span class="s2">&quot;&quot;&quot;</span>
        
    <span class="c1"># 生成选项</span>
    <span class="k">if</span> <span class="n">qconfig</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># 问的是正确选项：1个正确项 + （opt_num - 1)个错误项</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_ans_index = randint(0, opt_num - 1)</span>
<span class="s2">_opts = _pool_unsatisfied[:_ans_index] + _pool_satisfied + _pool_unsatisfied[_ans_index:]</span>
<span class="s2">_configs = _pool_unsatisfied_configs[:_ans_index] + _pool_satisfied_configs + _pool_unsatisfied_configs[_ans_index:]</span>
<span class="s2">config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;][&quot;pool&quot;] = _configs</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># 问的是错误选项：1个错误项 + （opt_num - 1)个正确项</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_ans_index = randint(0, opt_num - 1)</span>
<span class="s2">_opts = _pool_satisfied[:_ans_index] + _pool_unsatisfied + _pool_satisfied[_ans_index:]</span>
<span class="s2">_configs = _pool_satisfied_configs[:_ans_index] + _pool_unsatisfied_configs + _pool_satisfied_configs[_ans_index:]</span>
<span class="s2">config[&quot;_queries&quot;][&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;][&quot;pool&quot;] = _configs</span>
<span class="s2">&quot;&quot;&quot;</span>
        
    <span class="n">codegen</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_opt_text = []</span>
<span class="s2">_opt_texts = </span><span class="si">{</span><span class="p">[</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;opt_text&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]]</span><span class="si">}</span>
<span class="s2">for _index, _opt in enumerate(_opts):</span>
<span class="s2">    _opt_template_id = _configs[_index][&quot;template_id&quot;]</span>
<span class="s2">    _opt_text_template = &quot;f</span><span class="se">\\\&quot;</span><span class="s2">&quot; + _opt_texts[_opt_template_id] + &quot;</span><span class="se">\\\&quot;</span><span class="s2">&quot;</span>
<span class="s2">    _opt_text.append(chr(_index + 65) + &#39;. &#39; + eval(_opt_text_template))</span>
<span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc += &#39;</span><span class="se">\\</span><span class="s2">n&#39;.join(_opt_text) + &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span>
<span class="s2">queries += </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">. </span><span class="se">\&quot;</span><span class="s2"> + </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc + &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span>
<span class="s2">ans.append(chr(_ans_index + 65))</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">_sources</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]:</span>
        <span class="n">_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_config_opts = config[&quot;_queries&quot;][</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">][&quot;pool&quot;]</span>
<span class="s2">_opts = []</span>
<span class="s2">_sources = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_sources</span><span class="p">)</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">for _opt in _config_opts:</span>
<span class="s2">    _opt_template_id = _opt[&quot;template_id&quot;]</span>
<span class="s2">    _opt_config = _opt[&quot;config&quot;]</span>
<span class="s2">    _opts.append([[list(src)[int(m.group(1))] if (m := INDEX_PATTERN.match(str(idx))) else list(src)[idx] for idx in idx_tuple] for src, idx_tuple in zip(_sources[_opt_template_id], _opt_config)])</span>

<span class="s2">_opt_text = []</span>
<span class="s2">_opt_texts = </span><span class="si">{</span><span class="p">[</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;opt_text&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]]</span><span class="si">}</span>
<span class="s2">for _index, (_opt_config, _opt) in enumerate(zip(_config_opts, _opts)):</span>
<span class="s2">    _opt_template_id = _opt_config[&quot;template_id&quot;]</span>
<span class="s2">    _opt_text_template = &quot;f</span><span class="se">\\</span><span class="s2">&quot;&quot; + _opt_texts[_opt_template_id] + &quot;</span><span class="se">\\</span><span class="s2">&quot;&quot;</span>
<span class="s2">    _opt_text.append(chr(_index + 65) + &#39;. &#39; + eval(_opt_text_template))</span>
<span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc += &#39;</span><span class="se">\\</span><span class="s2">n&#39;.join(_opt_text) + &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span>
<span class="s2">_ans_index = &quot;&quot;</span>
<span class="s2">for _ind, (_opt_config, _opt) in enumerate(zip(_config_opts, _opts)):</span>
<span class="s2">    _opt_template_id = _opt_config[&quot;template_id&quot;]</span>
<span class="s2">    _opt_formulas = </span><span class="si">{</span><span class="p">[</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;opt_formula&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]]</span><span class="si">}</span>
<span class="s2">    _conds = </span><span class="si">{</span><span class="p">[</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;cond&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]]</span><span class="si">}</span>
<span class="s2">    if is_option_valid(_opt, _opt_formulas[_opt_template_id], _conds[_opt_template_id], </span><span class="si">{</span><span class="n">qconfig</span><span class="p">[</span><span class="s2">&quot;select_type&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, globals()):</span>
<span class="s2">        _ans_index += chr(_ind + 65)</span>
<span class="s2">queries += </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">. </span><span class="se">\&quot;</span><span class="s2"> + </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">.desc + &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span>
<span class="s2">ans.append(_ans_index)</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span></div>

<div class="viewcode-block" id="translator">
<a class="viewcode-back" href="../translator.html#translator.translator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">translator</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">=</span> <span class="n">init_program</span><span class="p">()</span> <span class="c1"># the result program</span>
    
    <span class="c1"># process custom operator</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_operator&#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">process_custom_operator</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;custom_operator&#39;</span><span class="p">])</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># process variables</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;variables&#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">process_vars</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">])</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbols&#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">process_symbols</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Initialize _conditions even if no conditions are specified</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conditions&#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">process_conditions</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;conditions&#39;</span><span class="p">])</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Initialize empty conditions</span>
        <span class="n">codesol</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">_conditions = []</span>
<span class="s2">conditions = &quot;&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span>

    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post_generation&#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">process_post_generation</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;post_generation&#39;</span><span class="p">],</span> <span class="n">calc_solution</span><span class="o">=</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;calc_solution&#39;</span><span class="p">])</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimize&#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">process_optimize</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;optimize&#39;</span><span class="p">])</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;calc_solution&#39;</span><span class="p">):</span>
        <span class="n">codesol</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;_solver = Solver()</span>
<span class="s2">for cond in _conditions:</span>
<span class="s2">    _solver.add(cond)</span>
<span class="s2">_solver_size = len(_solver.assertions())</span>
<span class="s2">_solutions = []</span>
<span class="s2">try:</span>
<span class="s2">    while _solver.check() == sat:</span>
<span class="s2">        model = _solver.model()  # 获取当前解</span>
<span class="s2">        _solutions.append(model)  # 保存解</span>
<span class="s2">        if(len(_solutions) &gt; </span><span class="si">{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;max_solution&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">):</span>
<span class="s2">            raise TooManySolutionsError(f&quot;Found </span><span class="se">{{</span><span class="s2">len(_solutions)</span><span class="se">}}</span><span class="s2"> solutions, which exceeds the maximum allowed (</span><span class="si">{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;max_solution&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">). This typically means the constraints are too loose. Please retry, use &#39;-c&#39; for continuous mode, or consider adding more specific constraints to reduce the solution space, or increase the max_solution limit if appropriate.&quot;)</span>
<span class="s2">        </span>
<span class="s2">        # 添加排除条件：排除当前解的所有变量赋值</span>
<span class="s2">        block = []</span>
<span class="s2">        for var in model:</span>
<span class="s2">            block.append(var() != model[var])  # 对每个变量添加反向约束</span>
<span class="s2">        _solver.add(Or(block))  # 要求至少有一个变量与当前解不同</span>
<span class="s2">except Exception as e:</span>
<span class="s2">    if isinstance(e, TooManySolutionsError):</span>
<span class="s2">        raise e</span>
<span class="s2">    else:</span>
<span class="s2">        raise RandomGenerationError(f&quot;Z3 solver encountered an error during solution generation: </span><span class="se">{{</span><span class="s2">str(e)</span><span class="se">}}</span><span class="s2">. This might be due to timeout or resource constraints. Please retry, use &#39;-c&#39; for continuous mode, or try again or simplify the constraints.&quot;)</span>

<span class="s2">if len(_solutions) == 0:</span>
<span class="s2">    # Get more detailed information about why there&#39;s no solution</span>
<span class="s2">    _unsat_core = _solver.unsat_core() if hasattr(_solver, &#39;unsat_core&#39;) else []</span>
<span class="s2">    _core_info = f&quot; Unsatisfiable core: </span><span class="se">{{</span><span class="s2">[str(c) for c in _unsat_core]</span><span class="se">}}</span><span class="s2">&quot; if _unsat_core else &quot;&quot;</span>
<span class="s2">    raise NoSolutionError(f&quot;Z3 solver could not find any solution that satisfies all the given constraints. This means the constraints are contradictory or too restrictive.</span><span class="se">{{</span><span class="s2">_core_info</span><span class="se">}}</span><span class="s2"> Please retry, use &#39;-c&#39; for continuous mode, or review your puzzle specification and ensure the constraints are consistent and achievable.&quot;)</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="s2">&quot;print(</span><span class="se">\&quot;</span><span class="s2">solution number:</span><span class="se">\&quot;</span><span class="s2">, len(_solutions)) </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="c1"># if spec[&quot;assert_one_solution&quot;]:</span>
        <span class="c1">#     codegen += &quot;assert(len(_solutions) == 1)\n&quot;</span>
        <span class="c1">#     codeval += &quot;assert(len(_solutions) == 1)\n&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">codesol</span> <span class="o">=</span> <span class="s2">&quot;_solver_size = 0</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span>

    <span class="c1"># process queries</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;queries&#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">process_query</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;queries&#39;</span><span class="p">])</span>
        <span class="n">codegen</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codeval</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">codesol</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;problem = f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="si">{</span><span class="n">ext</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">print(problem)</span>
<span class="s2">print(&#39;answer: &#39;, ans)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">codegen</span> <span class="o">+=</span> <span class="n">codesol</span>
    <span class="n">codeval</span> <span class="o">+=</span> <span class="n">codesol</span>

    <span class="c1"># with open(&quot;output.py&quot;, &quot;w&quot;, encoding=&#39;utf-8&#39;) as fp:</span>
    <span class="c1">#     fp.write(codegen)</span>
    
    <span class="k">return</span> <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span></div>



<div class="viewcode-block" id="process">
<a class="viewcode-back" href="../translator.html#translator.process">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">puzzle_template</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">=</span> <span class="n">translator</span><span class="p">(</span><span class="n">puzzle_template</span><span class="p">)</span>
        <span class="c1">#   print(code)</span>

        <span class="c1"># for debug</span>
        <span class="k">if</span> <span class="s1">&#39;-t&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;output.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">codegen</span><span class="p">)</span>

        <span class="n">symlist_code</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#   print(config)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">codegen</span><span class="p">,</span> <span class="n">symlist_code</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">symlist_code</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="n">codeval</span> <span class="o">=</span> <span class="n">codeval</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__config__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;-t&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;output_val.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">codeval</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;config.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="n">symlist_code</span><span class="p">[</span><span class="s2">&quot;problem&quot;</span><span class="p">]</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">symlist_code</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span>
        <span class="n">sym_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">puzzle_template</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;symbols&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">defined_symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">symbols</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">defined_symbols</span><span class="p">:</span>
                <span class="n">sym_num</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">symlist_code</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
            <span class="n">sym_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
                <span class="n">item</span> 
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defined_symbols</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]])</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">defined_symbols</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sym_type</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cond_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">symlist_code</span><span class="p">[</span><span class="s2">&quot;_solver_size&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;problem&quot;</span><span class="p">:</span> <span class="n">problem</span><span class="p">,</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">answer</span><span class="p">,</span>
            <span class="c1"># &quot;solution&quot;: codeval,</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;cond_num&quot;</span><span class="p">:</span> <span class="n">cond_num</span><span class="p">,</span>
                <span class="s2">&quot;sym_num&quot;</span><span class="p">:</span> <span class="n">sym_num</span><span class="p">,</span>
                <span class="s2">&quot;sym_type&quot;</span><span class="p">:</span>  <span class="n">sym_type</span><span class="p">,</span>
                <span class="o">**</span><span class="p">({</span><span class="s2">&quot;opt_solution&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">symlist_code</span><span class="p">[</span><span class="s1">&#39;_solutions&#39;</span><span class="p">])}</span> <span class="k">if</span> <span class="n">puzzle_template</span><span class="p">[</span><span class="s2">&quot;optimize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{})</span>
            <span class="p">},</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">NoSolutionError</span><span class="p">,</span> <span class="n">TooManySolutionsError</span><span class="p">,</span> <span class="n">AnswerAssertionError</span><span class="p">,</span> <span class="n">RandomGenerationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Re-raise our custom exceptions with their detailed messages</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch any other unexpected errors and provide a generic message</span>
        <span class="k">raise</span> <span class="n">PuzzleGenerationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during puzzle generation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Please retry, use &#39;-c&#39; for continuous mode, or check your puzzle specification for syntax errors or invalid configurations, and try again.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="repeat_process">
<a class="viewcode-back" href="../translator.html#translator.repeat_process">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">repeat_process</span><span class="p">(</span><span class="n">puzzle_spec_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">new_puzzles_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;-t&quot;</span><span class="p">):</span>
    
    <span class="n">puzzle_template</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">puzzle_spec_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># for yaml files</span>
            <span class="k">if</span> <span class="n">puzzle_spec_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
                <span class="n">puzzle_template</span> <span class="o">=</span> <span class="n">PuzzleTemplate</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">puzzle_template</span> <span class="o">=</span> <span class="n">PuzzleTemplate</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># puzzle_template_json = puzzle_template.model_dump_json(indent=2)  # 转换为 JSON str</span>
            <span class="n">puzzle_template</span> <span class="o">=</span> <span class="n">puzzle_template</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>  <span class="c1"># 转换为 JSON Data</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">puzzle_template</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">new_puzzles_num</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Keep retrying until successful</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">puzzle_template</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                    <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">break</span>  <span class="c1"># Exit the while loop and move to next puzzle</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">NoSolutionError</span><span class="p">,</span> <span class="n">TooManySolutionsError</span><span class="p">,</span> <span class="n">AnswerAssertionError</span><span class="p">,</span> <span class="n">RandomGenerationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;-c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="c1"># In continuous mode, just retry the same puzzle</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;-c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="c1"># In continuous mode, just retry the same puzzle</span>
                    <span class="k">continue</span>
    <span class="k">return</span> <span class="kc">True</span> </div>


<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<div class="viewcode-block" id="parse_config_file">
<a class="viewcode-back" href="../translator.html#translator.parse_config_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_config_file</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">config_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="c1"># First try to parse as JSON (single object)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">config_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">config_list</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="c1"># If not JSON, try as JSONL (each line is a JSON object)</span>
                <span class="k">pass</span>
            
            <span class="c1"># Reset file pointer to beginning for JSONL processing</span>
            <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Process as JSONL</span>
            <span class="k">for</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;config&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="n">line_number</span><span class="si">}</span><span class="s2"> does not contain &#39;config&#39; field&quot;</span><span class="p">)</span>
                    <span class="n">config_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON at line </span><span class="si">{</span><span class="n">line_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="n">config_list</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing config file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span></div>


<div class="viewcode-block" id="process_with_config">
<a class="viewcode-back" href="../translator.html#translator.process_with_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_with_config</span><span class="p">(</span><span class="n">puzzle_spec_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
    <span class="n">puzzle_template</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">puzzle_spec_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">puzzle_template</span> <span class="o">=</span> <span class="n">PuzzleTemplate</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># puzzle_template_json = puzzle_template.model_dump_json(indent=2)  # 转换为 JSON str</span>
            <span class="n">puzzle_template</span> <span class="o">=</span> <span class="n">puzzle_template</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>  <span class="c1"># 转换为 JSON Data</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">puzzle_template</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="n">configs</span> <span class="o">=</span> <span class="n">parse_config_file</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

    <span class="n">codegen</span><span class="p">,</span> <span class="n">codeval</span> <span class="o">=</span> <span class="n">translator</span><span class="p">(</span><span class="n">puzzle_template</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">config_idx</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">configs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># config_index = codeval.find(&quot;__config__&quot;)</span>
                <span class="c1"># config_next_line_index = codeval[config_index:].find(&quot;\n&quot;) + config_index</span>
                <span class="c1"># codeval = codeval[:config_next_line_index] + f&#39;\n__use_spec_vars__ = {use_spec_vars}&#39; + codeval[config_next_line_index:]</span>
                <span class="n">codeval_new</span> <span class="o">=</span> <span class="n">codeval</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__config__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

                <span class="c1"># for debug</span>
                <span class="k">if</span> <span class="s1">&#39;-t&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;output.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">debug_file</span><span class="p">:</span>
                        <span class="n">debug_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">codeval_new</span><span class="p">)</span>

                <span class="n">symlist_code</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1">#   print(config)</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">codeval_new</span><span class="p">,</span> <span class="n">symlist_code</span><span class="p">)</span>
                <span class="n">problem</span> <span class="o">=</span> <span class="n">symlist_code</span><span class="p">[</span><span class="s2">&quot;problem&quot;</span><span class="p">]</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="n">symlist_code</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span>
                <span class="n">config_modified</span> <span class="o">=</span> <span class="n">symlist_code</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
                <span class="n">sym_num</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">symbols</span> <span class="o">=</span> <span class="n">puzzle_template</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;symbols&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="n">symbols</span><span class="p">:</span>
                    <span class="n">defined_symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">symbols</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">defined_symbols</span><span class="p">:</span>
                        <span class="n">sym_num</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">symlist_code</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                    <span class="n">sym_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
                        <span class="n">item</span> 
                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defined_symbols</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]])</span>
                    <span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">defined_symbols</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">sym_type</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cond_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">symlist_code</span><span class="p">[</span><span class="s2">&quot;_solver_size&quot;</span><span class="p">])</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;problem&quot;</span><span class="p">:</span> <span class="n">problem</span><span class="p">,</span>
                    <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">answer</span><span class="p">,</span>
                    <span class="c1"># &quot;solution&quot;: codeval,</span>
                    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;cond_num&quot;</span><span class="p">:</span> <span class="n">cond_num</span><span class="p">,</span>
                        <span class="s2">&quot;sym_num&quot;</span><span class="p">:</span> <span class="n">sym_num</span><span class="p">,</span>
                        <span class="s2">&quot;sym_type&quot;</span><span class="p">:</span>  <span class="n">sym_type</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">({</span><span class="s2">&quot;opt_solution&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">symlist_code</span><span class="p">[</span><span class="s1">&#39;_solutions&#39;</span><span class="p">])}</span> <span class="k">if</span> <span class="n">puzzle_template</span><span class="p">[</span><span class="s2">&quot;optimize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{})</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config_modified</span>
                <span class="p">}</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">NoSolutionError</span><span class="p">,</span> <span class="n">TooManySolutionsError</span><span class="p">,</span> <span class="n">AnswerAssertionError</span><span class="p">,</span> <span class="n">RandomGenerationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️  Config-based puzzle generation failed for config #</span><span class="si">{</span><span class="n">config_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Skipping this configuration...&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Unexpected error processing config #</span><span class="si">{</span><span class="n">config_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Skipping this configuration...&quot;</span><span class="p">)</span>
                <span class="k">continue</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--deploy&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable deploy mode&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--test&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable test mode&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--num&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable test mode&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span><span class="s1">&#39;--continuous&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable continuous search&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify output file name&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;--config&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify configuration file&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--use-spec-vars&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Variables whose values depend on the specification during config-based generation&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">mode</span> <span class="o">=</span>  <span class="p">[]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">continuous</span><span class="p">:</span>
        <span class="n">mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">)</span>
    
    <span class="c1"># 根据参数选择模式</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">deploy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Either -d or -t should be specified.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">deploy</span><span class="p">:</span>
        <span class="c1"># Mode 2</span>
        <span class="n">puzzle_spec_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">deploy</span>
        <span class="n">new_puzzles_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">num</span> <span class="k">else</span> <span class="mi">1000</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">puzzle_spec_path</span><span class="p">),</span> <span class="s2">&quot;output_1k.jsonl&quot;</span><span class="p">)</span>
        <span class="n">mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">)</span>
        <span class="n">mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Mode 1</span>
        <span class="n">puzzle_spec_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">test</span>
        <span class="n">new_puzzles_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">num</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">puzzle_spec_path</span><span class="p">),</span> <span class="s2">&quot;output.jsonl&quot;</span><span class="p">)</span>
        <span class="n">mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">use_spec_vars</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">use_spec_vars</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_spec_vars</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">process_with_config</span><span class="p">(</span><span class="n">puzzle_spec_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">repeat_process</span><span class="p">(</span><span class="n">puzzle_spec_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">new_puzzles_num</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Anonymous Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>